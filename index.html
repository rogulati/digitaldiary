<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Record and save your stories">
  <meta name="theme-color" content="#ff5252">
  <link rel="manifest" href="./manifest.json">
  <link rel="icon" href="./icons/icon-192.png">
  <link rel="apple-touch-icon" href="./icons/icon-192.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./styles/style.css">
  <title>My Story Recorder</title>
</head>
<body>
  <header>
    <nav aria-label="Main navigation">
      <a href="./index.html" class="nav-link active" aria-label="Record">ğŸ™ï¸</a>
      <a href="./history.html" class="nav-link" aria-label="History">ğŸ“š</a>
      <a href="./kids.html" class="nav-link" aria-label="Kids">ğŸ‘§</a>
      <a href="./settings.html" class="nav-link" aria-label="Settings">âš™ï¸</a>
    </nav>
    <div id="offlineBanner" class="offline-banner hidden" role="alert">
      ğŸ“´ You're offline â€” recordings will be saved locally
    </div>
  </header>

  <main>
    <h1>ğŸ“– My Story</h1>
    <p id="kidName" class="subtitle"></p>

    <button id="recordBtn" class="big-button" aria-label="Start recording">
      ğŸ¤ Start Recording
    </button>

    <div id="recording-indicator" class="recording-indicator hidden" aria-live="polite">
      <span class="pulse-dot"></span> Recordingâ€¦
      <span id="timer">00:00</span>
    </div>

    <div id="liveTranscript" class="card hidden" aria-live="polite">
      <label>âœ¨ Live transcript</label>
      <p id="transcriptText" class="transcript-preview">Listeningâ€¦</p>
    </div>

    <div id="toast" class="toast hidden" role="status" aria-live="polite"></div>
  </main>

  <script type="module">
    import { showCurrentKid, showToast, updateOnlineStatus } from './scripts/app.js';
    import { startRecording, stopRecording } from './scripts/recorder.js';
    import { isSupported, startRecognition, stopRecognition } from './scripts/speech-recognition.js';

    const btn = document.getElementById('recordBtn');
    const indicator = document.getElementById('recording-indicator');
    const timerEl = document.getElementById('timer');
    const liveTranscript = document.getElementById('liveTranscript');
    const transcriptText = document.getElementById('transcriptText');
    let isRecording = false;
    let timerInterval = null;
    let seconds = 0;

    if (!isSupported) {
      showToast('Speech-to-text not supported in this browser. Try Chrome or Edge.', 'error');
    }

    function updateTimer() {
      seconds++;
      const m = String(Math.floor(seconds / 60)).padStart(2, '0');
      const s = String(seconds % 60).padStart(2, '0');
      timerEl.textContent = `${m}:${s}`;
    }

    btn.addEventListener('click', async () => {
      if (!isRecording) {
        try {
          await startRecording();
          isRecording = true;
          btn.textContent = 'â¹ï¸ Stop Recording';
          btn.classList.add('recording');
          indicator.classList.remove('hidden');
          liveTranscript.classList.remove('hidden');
          transcriptText.textContent = 'Listeningâ€¦';
          seconds = 0;
          timerInterval = setInterval(updateTimer, 1000);

          // Start live speech recognition in parallel
          if (isSupported) {
            startRecognition({
              onUpdate: (text) => {
                transcriptText.textContent = text || 'Listeningâ€¦';
              },
            });
          }
        } catch (err) {
          showToast('Could not access microphone. Please allow mic access.', 'error');
        }
      } else {
        clearInterval(timerInterval);

        // Stop both audio recording and speech recognition
        const audioBlob = await stopRecording();
        const transcript = isSupported ? stopRecognition() : '';

        isRecording = false;
        btn.textContent = 'ğŸ¤ Start Recording';
        btn.classList.remove('recording');
        indicator.classList.add('hidden');
        liveTranscript.classList.add('hidden');

        // Store audio blob AND transcript in IndexedDB
        const { savePendingRecording } = await import('./scripts/storage.js');
        await savePendingRecording(audioBlob, transcript);
        window.location.href = './review.html';
      }
    });

    showCurrentKid();
    updateOnlineStatus();
  </script>
</body>
</html>
