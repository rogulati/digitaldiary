<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#ff5252">
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" href="/icons/icon-192.png">
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/styles/style.css">
  <title>Review Story</title>
</head>
<body>
  <header>
    <nav aria-label="Main navigation">
      <a href="/" class="nav-link" aria-label="Record">ğŸ™ï¸</a>
      <a href="/history.html" class="nav-link" aria-label="History">ğŸ“š</a>
      <a href="/kids.html" class="nav-link" aria-label="Kids">ğŸ‘§</a>
      <a href="/settings.html" class="nav-link" aria-label="Settings">âš™ï¸</a>
    </nav>
    <div id="offlineBanner" class="offline-banner hidden" role="alert">
      ğŸ“´ You're offline
    </div>
  </header>

  <main>
    <h1>ğŸ§ Listen & Edit</h1>

    <audio id="player" controls aria-label="Story playback"></audio>

    <div class="card">
      <label for="storyTitle">Story Title</label>
      <input type="text" id="storyTitle" placeholder="Give your story a name!" maxlength="100">

      <label for="storyText">Story Text</label>
      <textarea id="storyText" rows="8" placeholder="Your story text appears here â€” you can edit it too!"></textarea>
    </div>

    <div class="card">
      <label for="voiceSelect">Read-aloud voice</label>
      <select id="voiceSelect" aria-label="Select character voice">
        <option value="default-high">ğŸ§š Fairy (high pitch)</option>
        <option value="default-low">ğŸ» Bear (low pitch)</option>
      </select>
      <div class="button-row">
        <button id="speakBtn" class="action-button" aria-label="Read story aloud">
          ğŸ”Š Read Story
        </button>
        <button id="stopSpeakBtn" class="action-button secondary" aria-label="Stop reading">
          ğŸ”‡ Stop
        </button>
      </div>
    </div>

    <div class="button-row">
      <button id="saveBtn" class="big-button" aria-label="Save story">
        ğŸ’¾ Save Story
      </button>
    </div>

    <div id="toast" class="toast hidden" role="status" aria-live="polite"></div>
  </main>

  <script type="module">
    import { showToast, updateOnlineStatus } from '/scripts/app.js';
    import { getPendingRecording, saveStory } from '/scripts/storage.js';
    import { speakStory, stopSpeaking } from '/scripts/tts.js';

    const player = document.getElementById('player');
    const storyText = document.getElementById('storyText');
    const storyTitle = document.getElementById('storyTitle');

    // Load the pending audio + transcript from IndexedDB
    async function loadPending() {
      const pending = await getPendingRecording();
      if (pending?.blob) {
        player.src = URL.createObjectURL(pending.blob);
      } else {
        showToast('No recording found. Go back and record first.', 'error');
      }
      if (pending?.transcript) {
        storyText.value = pending.transcript;
      }
    }

    // TTS
    document.getElementById('speakBtn').addEventListener('click', () => {
      if (!storyText.value.trim()) { showToast('No story text to read', 'error'); return; }
      const voice = document.getElementById('voiceSelect').value;
      speakStory(storyText.value, voice);
    });

    document.getElementById('stopSpeakBtn').addEventListener('click', stopSpeaking);

    // Save
    document.getElementById('saveBtn').addEventListener('click', async () => {
      const pending = await getPendingRecording();
      const kidId = localStorage.getItem('selectedKid') || 'default';
      const story = {
        kidId,
        title: storyTitle.value || 'Untitled Story',
        text: storyText.value,
        audioBlob: pending?.blob || null,
        createdAt: new Date().toISOString(),
      };
      await saveStory(story);
      showToast('Story saved! ğŸ‰');
      setTimeout(() => { window.location.href = '/history.html'; }, 1200);
    });

    loadPending();
    updateOnlineStatus();
  </script>
</body>
</html>
