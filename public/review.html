<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#ff5252">
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" href="/icons/icon-192.png">
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/styles/style.css">
  <title>Review Story</title>
</head>
<body>
  <header>
    <nav aria-label="Main navigation">
      <a href="/" class="nav-link" aria-label="Record">ğŸ™ï¸</a>
      <a href="/history.html" class="nav-link" aria-label="History">ğŸ“š</a>
      <a href="/kids.html" class="nav-link" aria-label="Kids">ğŸ‘§</a>
      <a href="/settings.html" class="nav-link" aria-label="Settings">âš™ï¸</a>
    </nav>
    <div id="offlineBanner" class="offline-banner hidden" role="alert">
      ğŸ“´ You're offline â€” AI features unavailable
    </div>
  </header>

  <main>
    <h1>ğŸ§ Listen & Edit</h1>

    <audio id="player" controls aria-label="Story playback"></audio>

    <div class="card">
      <label for="storyTitle">Story Title</label>
      <input type="text" id="storyTitle" placeholder="My Amazing Story" maxlength="100">

      <label for="storyText">Story Text</label>
      <textarea id="storyText" rows="8" placeholder="Your story will appear here after transcriptionâ€¦"></textarea>
    </div>

    <div class="button-row">
      <button id="transcribeBtn" class="action-button" aria-label="Transcribe audio">
        ğŸ¤– Transcribe
      </button>
      <button id="titleBtn" class="action-button" aria-label="Generate title">
        âœ¨ Auto Title
      </button>
      <button id="punctuateBtn" class="action-button" aria-label="Fix punctuation">
        ğŸ“ Fix Text
      </button>
    </div>

    <div class="card">
      <label for="voiceSelect">Read-aloud voice</label>
      <select id="voiceSelect" aria-label="Select character voice">
        <option value="default-high">ğŸ§š Fairy (high pitch)</option>
        <option value="default-low">ğŸ» Bear (low pitch)</option>
      </select>
      <button id="speakBtn" class="action-button" aria-label="Read story aloud">
        ğŸ”Š Read Story
      </button>
      <button id="stopSpeakBtn" class="action-button secondary" aria-label="Stop reading">
        ğŸ”‡ Stop
      </button>
    </div>

    <div class="button-row">
      <button id="saveBtn" class="big-button" aria-label="Save story">
        ğŸ’¾ Save Story
      </button>
    </div>

    <div id="toast" class="toast hidden" role="status" aria-live="polite"></div>
    <div id="spinner" class="spinner hidden" aria-label="Loading"></div>
  </main>

  <script type="module">
    import { showToast, updateOnlineStatus } from '/scripts/app.js';
    import { getPendingAudio, saveStory } from '/scripts/storage.js';
    import { speakStory, stopSpeaking } from '/scripts/tts.js';

    const player = document.getElementById('player');
    const storyText = document.getElementById('storyText');
    const storyTitle = document.getElementById('storyTitle');
    const spinner = document.getElementById('spinner');

    // Load the pending audio from IndexedDB (not localStorage!)
    async function loadAudio() {
      const blob = await getPendingAudio();
      if (blob) {
        player.src = URL.createObjectURL(blob);
      } else {
        showToast('No recording found. Go back and record first.', 'error');
      }
    }

    function showSpinner() { spinner.classList.remove('hidden'); }
    function hideSpinner() { spinner.classList.add('hidden'); }

    async function callApi(url, body) {
      if (!navigator.onLine) {
        showToast('You are offline. This feature needs internet.', 'error');
        return null;
      }
      showSpinner();
      try {
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.error || `Server error (${res.status})`);
        }
        return await res.json();
      } catch (err) {
        showToast(err.message, 'error');
        return null;
      } finally {
        hideSpinner();
      }
    }

    // Transcribe
    document.getElementById('transcribeBtn').addEventListener('click', async () => {
      const blob = await getPendingAudio();
      if (!blob) { showToast('No audio to transcribe', 'error'); return; }
      if (!navigator.onLine) { showToast('Transcription requires internet', 'error'); return; }

      showSpinner();
      try {
        const formData = new FormData();
        formData.append('audio', blob, 'recording.webm');
        const res = await fetch('/api/transcribe', { method: 'POST', body: formData });
        if (!res.ok) throw new Error('Transcription failed');
        const data = await res.json();
        storyText.value = data.text;
        showToast('Transcription complete!');
      } catch (err) {
        showToast(err.message, 'error');
      } finally {
        hideSpinner();
      }
    });

    // Auto title
    document.getElementById('titleBtn').addEventListener('click', async () => {
      if (!storyText.value.trim()) { showToast('Write or transcribe a story first', 'error'); return; }
      const data = await callApi('/api/title', { story: storyText.value });
      if (data) storyTitle.value = data.title;
    });

    // Punctuate
    document.getElementById('punctuateBtn').addEventListener('click', async () => {
      if (!storyText.value.trim()) { showToast('Write or transcribe a story first', 'error'); return; }
      const data = await callApi('/api/punctuate', { storyText: storyText.value });
      if (data) storyText.value = data.text;
    });

    // TTS
    document.getElementById('speakBtn').addEventListener('click', () => {
      if (!storyText.value.trim()) { showToast('No story text to read', 'error'); return; }
      const voice = document.getElementById('voiceSelect').value;
      speakStory(storyText.value, voice);
    });

    document.getElementById('stopSpeakBtn').addEventListener('click', stopSpeaking);

    // Save
    document.getElementById('saveBtn').addEventListener('click', async () => {
      const blob = await getPendingAudio();
      const kidId = localStorage.getItem('selectedKid') || 'default';
      const story = {
        kidId,
        title: storyTitle.value || 'Untitled Story',
        text: storyText.value,
        audioBlob: blob,
        createdAt: new Date().toISOString(),
      };
      await saveStory(story);
      showToast('Story saved! ğŸ‰');
      setTimeout(() => { window.location.href = '/history.html'; }, 1200);
    });

    loadAudio();
    updateOnlineStatus();
  </script>
</body>
</html>
